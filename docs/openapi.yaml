openapi: 3.1.0
info:
  title: TenRusl Payment Webhook Simulator API
  version: "1.0.0"
  description: |
    API untuk membuat pembayaran simulasi (idempotent) dan menerima webhook
    dari berbagai penyedia pembayaran. Status final ditentukan oleh webhook.

    Catatan desain:
    - Semua response membawa header `X-Request-ID` untuk tracing.
    - `POST /payments` mendukung idempotency via header `Idempotency-Key`.
  license:
    name: MIT
    identifier: MIT

# API public tidak butuh auth di root, tapi endpoint admin akan mendefinisikan security per-operation.
security: []

servers:
  - url: /api
    description: Canonical base (disarankan untuk frontend/admin)
  - url: /api/v1
    description: Compat base (alias versi v1; endpoint sama seperti canonical)

tags:
  - name: Payments
    description: Buat dan cek status pembayaran simulasi
  - name: Admin
    description: Endpoint untuk Admin UI (butuh admin key / bearer)
  - name: Webhooks
    description: Endpoint penerima webhook penyedia

paths:
  /payments:
    post:
      tags: [Payments]
      operationId: createPayment
      summary: Buat pembayaran simulasi (idempotent)
      description: |
        Kirim `Idempotency-Key` pada header untuk memastikan operasi idempotent.
        Status awal selalu `pending` sampai webhook diterima.
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
        - $ref: "#/components/parameters/XRequestIdRequest"
      requestBody:
        $ref: "#/components/requestBodies/CreatePaymentBody"
      responses:
        "201":
          description: Created
          headers:
            X-Request-ID:
              $ref: "#/components/headers/XRequestId"
            Idempotency-Key:
              $ref: "#/components/headers/IdempotencyKeyEcho"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentEnvelope"
              examples:
                created:
                  value:
                    data:
                      id: 01JCDZQ2F1G8W3X1R7SZM3KZ2S
                      provider: xendit
                      provider_ref: sim_xendit_01JCDZQ2F1G8W3X1R7SZM3KZ2S
                      amount: 100000
                      currency: IDR
                      status: pending
                      meta:
                        order_id: "ORD-12345"
                      created_at: "2025-12-01T09:00:00Z"
                      updated_at: "2025-12-01T09:00:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/IdempotencyConflict"
        "429":
          $ref: "#/components/responses/RateLimitedPayments"

  /payments/{id}:
    get:
      tags: [Payments]
      operationId: getPaymentById
      summary: Ambil payment berdasarkan ID (refresh by id)
      description: |
        Mengembalikan state payment terkini berdasarkan `id`.
        Untuk kebutuhan landing demo / admin refresh by id.
        (Bisa mengandung webhook events terkait bila server meng-include relasi.)
      parameters:
        - $ref: "#/components/parameters/PaymentId"
        - $ref: "#/components/parameters/XRequestIdRequest"
      responses:
        "200":
          description: OK
          headers:
            X-Request-ID:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentDetailEnvelope"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimitedStatus"

  /payments/{provider}/{provider_ref}/status:
    get:
      tags: [Payments]
      operationId: getPaymentStatusLegacy
      summary: Cek status pembayaran simulasi (legacy by provider_ref)
      parameters:
        - $ref: "#/components/parameters/Provider"
        - $ref: "#/components/parameters/ProviderRef"
        - $ref: "#/components/parameters/XRequestIdRequest"
      responses:
        "200":
          description: OK
          headers:
            X-Request-ID:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentEnvelope"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimitedStatus"

  /admin/payments:
    get:
      tags: [Admin]
      operationId: adminListPayments
      summary: List payments untuk Admin UI (pagination + filter)
      description: |
        Endpoint admin untuk table/listing pembayaran.
        Proteksi: kirim salah satu:
        - Header `X-Admin-Key: <key>`
        - Authorization `Bearer <token>`
      security:
        # OR: boleh pakai salah satu
        - adminApiKey: []
        - adminBearer: []
      parameters:
        - $ref: "#/components/parameters/XRequestIdRequest"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PerPage"
        - $ref: "#/components/parameters/FilterProvider"
        - $ref: "#/components/parameters/FilterStatus"
        - $ref: "#/components/parameters/FilterQuery"
        - $ref: "#/components/parameters/FilterCreatedFrom"
        - $ref: "#/components/parameters/FilterCreatedTo"
      responses:
        "200":
          description: OK
          headers:
            X-Request-ID:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentListEnvelope"
              examples:
                ok:
                  value:
                    data:
                      - id: 01JCDZQ2F1G8W3X1R7SZM3KZ2S
                        provider: xendit
                        provider_ref: sim_xendit_01JCDZQ2F1G8W3X1R7SZM3KZ2S
                        amount: 100000
                        currency: IDR
                        status: pending
                        meta: {}
                        created_at: "2025-12-01T09:00:00Z"
                        updated_at: "2025-12-01T09:00:00Z"
                    meta:
                      current_page: 1
                      per_page: 20
                      total: 1
                      last_page: 1
        "401":
          $ref: "#/components/responses/AdminUnauthorized"
        "429":
          $ref: "#/components/responses/RateLimitedPayments"

  /webhooks/{provider}:
    post:
      tags: [Webhooks]
      operationId: receiveWebhook
      summary: Terima webhook dari provider
      description: |
        Signature diverifikasi per provider.

        Header signature berbeda-beda per provider (Stripe-Signature, X-CALLBACK-TOKEN, dll).
        Implementasi simulator memverifikasi signature berdasarkan RAW body.
        Jika signature invalid, respon 401.

      security:
        - webhookSignature: []

      parameters:
        - $ref: "#/components/parameters/Provider"
        - $ref: "#/components/parameters/XRequestIdRequest"
        # contoh header signature (opsional, tergantung provider)
        - $ref: "#/components/parameters/StripeSignature"
        - $ref: "#/components/parameters/XenditCallbackToken"
        - $ref: "#/components/parameters/LemonSignature"
        - $ref: "#/components/parameters/AirwallexTimestamp"
        - $ref: "#/components/parameters/AirwallexSignature"
        - $ref: "#/components/parameters/DokuSignature"
      requestBody:
        $ref: "#/components/requestBodies/WebhookBody"
      responses:
        "202":
          description: Accepted (diproses idempotent & retry-aware)
          headers:
            X-Request-ID:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookReceiveEnvelope"
              examples:
                accepted:
                  value:
                    data:
                      event:
                        provider: xendit
                        event_id: evt_123
                        type: invoice.paid
                      result:
                        duplicate: false
                        persisted: true
                        status: succeeded
                        payment_provider_ref: sim_xendit_01JCDZQ...
                        next_retry_ms: null
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimitedWebhooks"

components:
  securitySchemes:
    # Admin security (documented): API key header OR Bearer token.
    adminApiKey:
      type: apiKey
      in: header
      name: X-Admin-Key
      description: Admin demo key (header-based)

    adminBearer:
      type: http
      scheme: bearer
      bearerFormat: "JWT"
      description: "Bearer token (Authorization: Bearer <token>)"

    webhookSignature:
      type: apiKey
      in: header
      name: X-Webhook-Signature
      description: |
        Skema generic untuk signature webhook. Di implementasi nyata, tiap provider
        menggunakan header yang berbeda (Stripe-Signature, X-CALLBACK-TOKEN, dll).

  parameters:
    PaymentId:
      name: id
      in: path
      required: true
      schema:
        type: string
        minLength: 10
      description: ID payment (ULID string)

    Provider:
      name: provider
      in: path
      required: true
      schema:
        type: string
        enum:
          - mock
          - xendit
          - midtrans
          - stripe
          - paypal
          - paddle
          - lemonsqueezy
          - airwallex
          - tripay
          - doku
          - dana
          - oy
          - payoneer
          - skrill
          - amazon_bwp
      description: Nama provider (sesuai allowlist)

    ProviderRef:
      name: provider_ref
      in: path
      required: true
      schema:
        type: string
        pattern: "^[A-Za-z0-9\\-\\._]+$"
      description: Referensi payment di simulator (provider_ref)

    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
        minLength: 8
        maxLength: 255
      description: |
        Kunci idempotensi untuk POST /payments.
        Jika request diulang dengan body yang sama → respon sama.
        Jika request paralel dengan state berbeda → 409.

    XRequestIdRequest:
      name: X-Request-ID
      in: header
      required: false
      schema:
        type: string
        maxLength: 128
      description: Correlation / request ID dari client (opsional)

    # Admin pagination + filter
    Page:
      name: page
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Halaman (pagination)

    PerPage:
      name: per_page
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Jumlah item per halaman

    FilterProvider:
      name: provider
      in: query
      required: false
      schema:
        type: string
      description: Filter provider (exact match)

    FilterStatus:
      name: status
      in: query
      required: false
      schema:
        type: string
        enum: [pending, succeeded, failed]
      description: Filter status payment

    FilterQuery:
      name: q
      in: query
      required: false
      schema:
        type: string
      description: Search sederhana (mis. provider_ref)

    FilterCreatedFrom:
      name: created_from
      in: query
      required: false
      schema:
        type: string
        format: date
      description: Filter tanggal mulai (YYYY-MM-DD)

    FilterCreatedTo:
      name: created_to
      in: query
      required: false
      schema:
        type: string
        format: date
      description: Filter tanggal akhir (YYYY-MM-DD)

    # contoh header signature (opsional)
    StripeSignature:
      name: Stripe-Signature
      in: header
      required: false
      schema:
        type: string
      description: Stripe signature header

    XenditCallbackToken:
      name: X-CALLBACK-TOKEN
      in: header
      required: false
      schema:
        type: string
      description: Xendit callback token header

    LemonSignature:
      name: X-Signature
      in: header
      required: false
      schema:
        type: string
      description: Lemon Squeezy signature header

    AirwallexTimestamp:
      name: x-timestamp
      in: header
      required: false
      schema:
        type: string
      description: Airwallex timestamp header

    AirwallexSignature:
      name: x-signature
      in: header
      required: false
      schema:
        type: string
      description: Airwallex signature header

    DokuSignature:
      name: Signature
      in: header
      required: false
      schema:
        type: string
      description: DOKU signature header

  headers:
    XRequestId:
      schema:
        type: string
      description: Correlation/request ID untuk tracing server-side

    IdempotencyKeyEcho:
      schema:
        type: string
      description: Idempotency-Key yang digunakan dalam permintaan

    RetryAfter:
      schema:
        type: integer
      description: Detik sampai klien boleh mencoba kembali

  requestBodies:
    CreatePaymentBody:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CreatePaymentRequest"
          examples:
            basic:
              value:
                provider: xendit
                amount: 100000
                currency: IDR
                description: "Top up"
                metadata:
                  order_id: "ORD-12345"

    WebhookBody:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/WebhookAnyPayload"
          examples:
            generic:
              value:
                id: evt_123
                status: paid
                data:
                  object:
                    id: sim_xendit_01JCDZQ...
                    status: paid
        application/x-www-form-urlencoded:
          schema:
            type: object
            additionalProperties: true

  responses:
    BadRequest:
      description: Bad Request (validasi gagal / payload tidak sesuai)
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            bad_request:
              value:
                message: "Invalid payload"
                code: "validation_error"
                trace_id: "01JCDZQ2F1G8W3X1R7SZM3KZ2S"
                details:
                  provider: ["The provider field is required."]

    Unauthorized:
      description: Signature webhook tidak valid / tidak lolos auth
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            invalid_signature:
              value:
                error:
                  code: "unauthorized"
                  message: "Invalid webhook signature."
                  provider: "xendit"

    AdminUnauthorized:
      description: Unauthorized (admin key/bearer tidak valid)
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            unauthorized:
              value:
                message: "Unauthorized"
                code: "unauthorized"

    NotFound:
      description: Resource tidak ditemukan
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            not_found:
              value:
                message: "Payment not found"
                code: "not_found"

    IdempotencyConflict:
      description: Idempotency conflict (parallel call dengan state berbeda)
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            conflict:
              value:
                message: "Idempotency conflict"
                code: "idempotency_conflict"

    RateLimitedPayments:
      description: Terlalu banyak request ke endpoint payments
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
        Retry-After:
          $ref: "#/components/headers/RetryAfter"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"

    RateLimitedStatus:
      description: Terlalu banyak request ke endpoint payment status
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
        Retry-After:
          $ref: "#/components/headers/RetryAfter"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"

    RateLimitedWebhooks:
      description: Terlalu banyak webhook ke endpoint ini (rate limited)
      headers:
        X-Request-ID:
          $ref: "#/components/headers/XRequestId"
        Retry-After:
          $ref: "#/components/headers/RetryAfter"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"

  schemas:
    # Error shape bisa 2 gaya (legacy vs envelope error), biar doc tahan perubahan minor.
    ErrorEnvelope:
      oneOf:
        - type: object
          additionalProperties: true
          properties:
            message:
              type: string
            code:
              type: string
            provider:
              type: string
            trace_id:
              type: string
            details:
              type: object
              additionalProperties: true
          required: [message]
        - type: object
          additionalProperties: true
          properties:
            error:
              type: object
              additionalProperties: true
              properties:
                code:
                  type: string
                message:
                  type: string
                provider:
                  type: string
              required: [code, message]
          required: [error]

    CreatePaymentRequest:
      type: object
      additionalProperties: true
      required: [provider, amount, currency]
      properties:
        provider:
          type: string
          description: Nama provider (harus sesuai allowlist)
        amount:
          type: integer
          minimum: 1
          description: Satuan terkecil (minor unit)
        currency:
          type: string
          example: IDR
          pattern: "^[A-Z]{3}$"
        description:
          type: string
          maxLength: 255
        # meta dan metadata sama-sama diterima; disarankan pakai meta.
        meta:
          type: object
          additionalProperties: true
          description: Metadata bebas (disarankan)
        metadata:
          type: object
          additionalProperties: true
          description: Alias legacy; dipetakan ke 'meta'

    Payment:
      type: object
      additionalProperties: true
      required: [id, provider, provider_ref, status]
      properties:
        id:
          type: string
          example: 01JCDZQ2F1G8W3X1R7SZM3KZ2S
        provider:
          type: string
          example: xendit
        provider_ref:
          type: string
          example: sim_xendit_01JCDZQ2F1...
        amount:
          type: integer
          example: 100000
        currency:
          type: string
          example: IDR
        status:
          type: string
          enum: [pending, succeeded, failed]
          example: pending
        meta:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    WebhookEvent:
      type: object
      additionalProperties: true
      required: [id, provider, event_id, status, attempts]
      properties:
        id:
          type: string
          description: ID event (ULID)
        payment_id:
          type: string
          description: Relasi payment (ULID)
        provider:
          type: string
        event_id:
          type: string
          description: Dedup key per provider
        event_type:
          type: string
        status:
          type: string
          enum: [received, processed, failed]
        attempts:
          type: integer
          minimum: 0
        received_at:
          type: string
          format: date-time
        last_attempt_at:
          type: string
          format: date-time
        processed_at:
          type: string
          format: date-time
        next_retry_at:
          type: string
          format: date-time
        error_message:
          type: string
        payment_provider_ref:
          type: string
        payment_status:
          type: string
          enum: [pending, succeeded, failed]
        payload:
          type: object
          additionalProperties: true

    PaymentDetail:
      allOf:
        - $ref: "#/components/schemas/Payment"
        - type: object
          additionalProperties: true
          properties:
            webhook_events:
              type: array
              items:
                $ref: "#/components/schemas/WebhookEvent"

    PaymentEnvelope:
      type: object
      additionalProperties: true
      properties:
        data:
          $ref: "#/components/schemas/Payment"
      required: [data]

    PaymentDetailEnvelope:
      type: object
      additionalProperties: true
      properties:
        data:
          $ref: "#/components/schemas/PaymentDetail"
      required: [data]

    PaginationMeta:
      type: object
      additionalProperties: true
      required: [current_page, per_page, total, last_page]
      properties:
        current_page:
          type: integer
          minimum: 1
        per_page:
          type: integer
          minimum: 1
        total:
          type: integer
          minimum: 0
        last_page:
          type: integer
          minimum: 1

    PaymentListEnvelope:
      type: object
      additionalProperties: true
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Payment"
        meta:
          $ref: "#/components/schemas/PaginationMeta"

    WebhookAnyPayload:
      type: object
      additionalProperties: true
      description: |
        Payload webhook berbeda-beda tiap provider.
        Untuk simulator ini, payload diterima sebagai object bebas.

    WebhookReceiveResult:
      type: object
      additionalProperties: true
      required: [duplicate, persisted, status]
      properties:
        duplicate:
          type: boolean
        persisted:
          type: boolean
        status:
          type: string
          enum: [pending, succeeded, failed]
        payment_provider_ref:
          oneOf:
            - type: string
            - type: "null"
        next_retry_ms:
          oneOf:
            - type: integer
            - type: "null"

    WebhookReceiveEvent:
      type: object
      additionalProperties: true
      required: [provider, event_id]
      properties:
        provider:
          type: string
        event_id:
          type: string
        type:
          oneOf:
            - type: string
            - type: "null"

    WebhookReceiveData:
      type: object
      additionalProperties: true
      required: [event, result]
      properties:
        event:
          $ref: "#/components/schemas/WebhookReceiveEvent"
        result:
          $ref: "#/components/schemas/WebhookReceiveResult"

    WebhookReceiveEnvelope:
      type: object
      additionalProperties: true
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/WebhookReceiveData"
