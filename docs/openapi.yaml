openapi: 3.1.0
info:
  title: TenRusl Payment Webhook Simulator API
  version: "1.0.0"
  description: |
    API untuk membuat pembayaran simulasi (idempotent) dan menerima webhook
    dari berbagai penyedia pembayaran. Status final ditentukan oleh webhook.
servers:
  - url: /
tags:
  - name: Payments
    description: Buat dan cek status pembayaran simulasi
  - name: Webhooks
    description: Endpoint penerima webhook penyedia
paths:
  /api/v1/payments:
    post:
      tags: [Payments]
      summary: Buat pembayaran simulasi (idempotent)
      description: |
        Kirim `Idempotency-Key` pada header untuk memastikan operasi idempotent.
        Status awal selalu `pending` sampai webhook diterima.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePaymentRequest"
            examples:
              basic:
                value:
                  provider: xendit
                  amount: 100000
                  currency: IDR
                  description: "Top up"
                  metadata:
                    order_id: "ORD-12345"
      responses:
        "201":
          description: Created
          headers:
            Idempotency-Key:
              schema:
                type: string
              description: Idempotency-Key yang digunakan dalam permintaan
            X-Request-ID:
              schema:
                type: string
              description: Correlation/request ID untuk tracing server-side
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Payment"
        "400":
          description: Bad Request (validasi gagal / payload tidak sesuai)
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Idempotency conflict (parallel call dengan state berbeda)
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: Terlalu banyak request ke endpoint payments
          headers:
            X-Request-ID:
              schema:
                type: string
            Retry-After:
              schema:
                type: integer
              description: Detik sampai klien boleh mencoba kembali
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /api/v1/payments/{provider}/{provider_ref}/status:
    get:
      tags: [Payments]
      summary: Cek status pembayaran simulasi
      parameters:
        - $ref: "#/components/parameters/Provider"
        - name: provider_ref
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Payment"
        "404":
          description: Payment tidak ditemukan
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: Terlalu banyak request ke endpoint status
          headers:
            X-Request-ID:
              schema:
                type: string
            Retry-After:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /api/v1/webhooks/{provider}:
    post:
      tags: [Webhooks]
      summary: Terima webhook dari provider
      description: |
        Signature diverifikasi per provider (lihat dokumentasi masing-masing).
        - Xendit: **X-CALLBACK-TOKEN**.
        - Midtrans: **signature_key** = SHA512(order_id + status_code + gross_amount + server_key).
        - DOKU: header **Signature** berbasis Client-Id, Request-Id, Request-Timestamp, Request-Target, Digest.
        - Airwallex: **x-timestamp** + **x-signature** = HMAC-SHA256(ts+rawBody).
        - Lemon Squeezy: **X-Signature** (HMAC-SHA256 raw body).
      parameters:
        - $ref: "#/components/parameters/Provider"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
          application/x-www-form-urlencoded:
            schema:
              type: object
      responses:
        "202":
          description: Accepted (diproses idempotent & retry-aware)
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      event:
                        type: object
                        properties:
                          provider: { type: string }
                          event_id: { type: string }
                          type: { type: string, nullable: true }
                      result:
                        type: object
                        properties:
                          duplicate: { type: boolean }
                          persisted: { type: boolean }
                          status: { type: string, enum: [pending, succeeded, failed] }
                          payment_provider_ref: { type: string, nullable: true }
                          next_retry_ms: { type: integer, nullable: true }
        "400":
          description: Payload webhook tidak valid
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Signature webhook tidak valid
          headers:
            X-Request-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "429":
          description: Terlalu banyak webhook ke endpoint ini (rate limited)
          headers:
            X-Request-ID:
              schema:
                type: string
            Retry-After:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
components:
  parameters:
    Provider:
      name: provider
      in: path
      required: true
      schema:
        type: string
        enum:
          - mock
          - xendit
          - midtrans
          - stripe
          - paypal
          - paddle
          - lemonsqueezy
          - airwallex
          - tripay
          - doku
          - dana
          - oy
          - payoneer
          - skrill
          - amazon_bwp
  securitySchemes:
    webhookSignature:
      type: apiKey
      in: header
      name: X-Webhook-Signature
      description: |
        Skema generic untuk signature webhook. Di implementasi nyata, tiap provider
        menggunakan header yang berbeda (Stripe-Signature, X-CALLBACK-TOKEN, dsb).
  schemas:
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Kode error singkat (mis. validation_error, not_found, rate_limited)
          example: validation_error
        message:
          type: string
          description: Pesan error yang dapat dibaca manusia
          example: Invalid payload
        trace_id:
          type: string
          description: ID tracing internal (X-Request-ID) untuk debugging/log
          example: 01JCDZQ2F1G8W3X1R7SZM3KZ2S
        details:
          type: object
          additionalProperties: true
          description: Informasi tambahan (mis. field error)
    CreatePaymentRequest:
      type: object
      required: [provider, amount, currency]
      properties:
        provider:
          type: string
          description: Nama provider (harus sesuai allowlist)
        amount:
          type: integer
          minimum: 1
          description: Satuan terkecil (mis. IDR)
        currency:
          type: string
          example: IDR
          pattern: "^[A-Z]{3}$"
        description:
          type: string
          maxLength: 255
        meta:
          type: object
          description: Direkomendasikan; metadata bebas
        metadata:
          type: object
          description: Alias yang masih diterima; akan dipetakan ke 'meta'
    Payment:
      type: object
      required: [provider, provider_ref, status]
      properties:
        id:
          type: string
          example: 01JCDZQ2F1G8W3X1R7SZM3KZ2S
        provider:
          type: string
          example: xendit
        provider_ref:
          type: string
          example: sim_xendit_01JCDZQ2F1...
        amount:
          type: integer
          example: 100000
          description: Satuan terkecil
        currency:
          type: string
          example: IDR
        status:
          type: string
          enum: [pending, succeeded, failed]
          example: pending
        meta:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WebhookEvent:
      type: object
      required: [provider, event_id]
      properties:
        id:
          type: string
        provider:
          type: string
        event_id:
          type: string
        event_type:
          type: string
          nullable: true
        payment_provider_ref:
          type: string
          nullable: true
        payment_status:
          type: string
          enum: [pending, succeeded, failed]
          nullable: true
        attempts:
          type: integer
        received_at:
          type: string
          format: date-time
        last_attempt_at:
          type: string
          format: date-time
        processed_at:
          type: string
          format: date-time
          nullable: true
        next_retry_at:
          type: string
          format: date-time
          nullable: true
        payload:
          type: object
