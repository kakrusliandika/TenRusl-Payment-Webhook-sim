<?php

return [

    'hint' => 'ترويسة x-amzn-signature في كل طلب.',

    'summary' => <<<'TEXT'
تقوم Buy with Prime (BWP) بتوقيع كل Webhook حتى تتمكن من التأكد من أنه صادر فعلاً من Amazon ولم يتم العبث به أثناء النقل. يتضمن كل طلب التوقيع الرقمي في ترويسة `x-amzn-signature`. يجب على المعالج لديك إعادة بناء التوقيع المتوقع تمامًا كما هو موثَّق في BWP لنوع الحدث وبيئة التشغيل المعنيَّين؛ إذا لم تتطابق القيم، فقم برفض الاستدعاء. تعامل مع أي طابع زمني (timestamp) أو nonce يأتي مع الطلب كجزء من استراتيجية الحماية ضد إعادة الإرسال (replay)، وفرض نافذة زمنية ضيقة للصلاحية وتخزين المعرفات التي تمت معالجتها لتجنب التكرار.

من الناحية التشغيلية، صمِّم الـ endpoint ليكون سريعًا وحتميًا: تحقَّق أولاً، ثم أرسل رد `2xx` بعد أن يتم تسجيل الحدث بأمان، ونفِّذ الأعمال الأثقل بشكل غير متزامن. إذا كنت تعتمد على قوائم السماح (allowlists)، فتذكَّر أن عناوين IP والشبكات يمكن أن تتغير—التحقق التشفيري هو الركيزة الأساسية للثقة. احتفظ بسجل تدقيق آمن (معرّف الطلب، وجود التوقيع، نتيجة التحقق، وتجزيء hash للجسم—وليس السر نفسه). في الاختبارات المحلية، يمكنك عمل stub لخطوة التحقق خلف متغيّر بيئة، مع التأكد من أن مسارات الإنتاج تتحقق دائمًا من التواقيع. عند تدوير المفاتيح أو تحديث قواعد الـ canonicalization، قم بالانتقال للأمام بحذر، وراقب معدلات الأخطاء، ووثِّق مجموعة الترويسات الدقيقة وقواعد التجزئة/التطبيع التي تطبقها حتى تبقى الخدمات الأخرى في منصتك متزامنة معها.

من ناحية سهولة التكامل، احرص على كشف **أسباب فشل واضحة** (توقيع غير صالح، طابع زمني منتهي، طلب غير صحيح) وأعد رموز أخطاء ثابتة بحيث يكون سلوك إعادة المحاولة قابلًا للتنبؤ. اجمع ذلك مع idempotency على مستوى التطبيق والحماية من إعادة الإرسال، بحيث تظل انتقالات حالة الدفع في الأنظمة الخلفية آمنة حتى في ظل إعادة المحاولة، أو الارتفاع المفاجئ في الطلبات، أو الانقطاعات الجزئية.
TEXT
    ,

    // Dari view amazon_bwp.blade.php
    'docs' => 'https://documents.buywithprime.amazon.com/bwp-api/docs/subscribe-to-events',

    'signature_notes' => [
        'قراءة `x-amzn-signature` من ترويسات الطلب.',
        'إعادة إنشاء التوقيع المتوقع تمامًا كما هو معرَّف في Buy with Prime (الخوارزمية/التطبيع وفق الوثائق الرسمية)؛ رفض الطلب عند عدم التطابق.',
        'إذا تم توفير طابع زمني/nonce، ففرض نافذة حداثة ضيقة للتقليل من هجمات إعادة الإرسال؛ خزن المعرفات التي تمت معالجتها لتجنب التكرار.',
    ],

    'example_payload' => [
        'eventType' => 'ORDER_COMPLETED',
        'data'      => [
            'orderId'  => 'BWP-001',
            'status'   => 'COMPLETED',
            'amount'   => 25000,
            'currency' => 'IDR',
        ],
        'provider' => 'amazon_bwp',
        'sent_at'  => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path'   => '/api/payments',
            'desc'   => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path'   => '/api/payments/{id}',
            'desc'   => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path'   => '/api/webhooks/amazon_bwp',
            'desc'   => __('pages.receive_webhook'),
        ],
    ],
];
