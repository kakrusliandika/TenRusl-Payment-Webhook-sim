<?php

return [

    'hint' => 'تجزئة HMAC-SHA256 على x-timestamp + body.',

    'summary' => <<<'TEXT'
تكون Webhook الخاصة بـ Airwallex موقَّعة بحيث يمكنك التحقق من صحة المصدر وسلامة المحتوى قبل لمس قاعدة البيانات. تتضمن كل طلبية ترويسَتين أساسيتين: `x-timestamp` و`x-signature`. للتحقق من رسالة ما، اقرأ جسم طلب HTTP الخام تمامًا كما وصل، ثم ضَع قيمة `x-timestamp` (كسلسلة نصية) متبوعة بالجسم الخام لتشكيل بيانات الإدخال، وبعد ذلك احسب HMAC باستخدام SHA-256 مع سر URL الإشعارات المشترك كمفتاح. تتوقع Airwallex أن تكون النتيجة على شكل **hex digest**؛ قارِنها مع الترويسة `x-signature` باستخدام مقارنة بزمن ثابت لتفادي تسريبات التوقيت. إذا لم تتطابق التواقيع، أو كان الطابع الزمني مفقودًا أو غير صالح، فافترض الفشل وأعد استجابة ليست 2xx.

نظرًا لأن هجمات إعادة الإرسال (replay) خطر حقيقي في أي نظام Webhook، طبِّق نافذة زمنية للحداثة على `x-timestamp`. ارفض الرسائل القديمة جدًا أو البعيدة في المستقبل، وخزّن معرّفات الأحداث التي تمت معالجتها لإزالة التكرار عن التأثيرات الجانبية في المراحل اللاحقة (idempotency على مستوى التطبيق). عامِل الـ payload على أنه غير موثوق به حتى تنجح عملية التحقق؛ لا تقم بإعادة تحويل JSON إلى نص قبل عمل التجزئة—استخدم البايتات الخام نفسها كما وصلت لتجنّب فروق طفيفة في المسافات أو الترتيب. عند نجاح التحقق، أعد استجابة `2xx` بسرعة، ونفّذ الأعمال الثقيلة بشكل غير متزامن للحفاظ على منطق إعادة المحاولة بسلوك سليم وتقليل التكرارات العرضية.

في بيئات التطوير المحلي وCI، تقدّم Airwallex أدوات قوية من الدرجة الأولى: يمكنك إعداد عناوين URL للإشعارات من لوحة التحكم، معاينة payloads تجريبية، و**إرسال أحداث اختبارية** إلى الـ endpoint الخاص بك. عند التصحيح (debugging)، سجِّل قيم `x-timestamp` المستلمة، ومعاينة للتوقيع المُحتسب (من دون تسجيل الأسرار)، وأي معرّف حدث إذا توفّر. عند تدوير (تغيير) مفتاح السر، نفّذ العملية بحذر وراقِب معدلات أخطاء التوقيع. وأخيرًا، وثّق السلسلة كاملة—التحقق، إزالة التكرار، إعادة المحاولة، واستجابات الأخطاء—حتى يتمكن أعضاء الفريق من إعادة إنتاج النتائج باستخدام قواعد التجزئة نفسها للجسم الخام ونفس النافذة الزمنية.
TEXT
    ,

    'docs' => 'https://www.airwallex.com/docs/developer-tools/webhooks/listen-for-webhook-events',

    'signature_notes' => [
        'استخراج `x-timestamp` و`x-signature` من الترويسات.',
        'بناء value_to_digest = <x-timestamp> + <جسم HTTP الخام> (بنفس البايتات بالضبط).',
        'حساب expected = HMAC-SHA256(value_to_digest, <webhook secret>) بصيغة HEX؛ ثم مقارنته مع `x-signature` باستخدام مقارنة بزمن ثابت.',
        'الرفض إذا لم تتطابق التواقيع أو كان الطابع الزمني قديماً؛ كذلك أزِل تكرار معرفات الأحداث المعالَجة لضمان idempotency.',
    ],

    'example_payload' => [
        'id' => 'evt_'.now()->timestamp,
        'type' => 'payment_intent.succeeded',
        'data' => [
            'payment_intent_id' => 'pi_awx_001',
            'amount' => 25000,
            'currency' => 'IDR',
            'status' => 'succeeded',
        ],
        'provider' => 'airwallex',
        'created_at' => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path' => '/api/payments',
            'desc' => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path' => '/api/payments/{id}',
            'desc' => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path' => '/api/webhooks/airwallex',
            'desc' => __('pages.receive_webhook'),
        ],
    ],
];
