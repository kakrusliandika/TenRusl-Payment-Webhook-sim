<?php

return [

    'hint' => 'Заголовок x-amzn-signature в каждом запросе.',

    'summary' => <<<'TEXT'
Buy with Prime (BWP) подписывает каждый webhook, чтобы вы могли подтвердить, что он действительно пришёл от Amazon и не был изменён в пути. Каждая просьба содержит цифровую подпись в заголовке `x-amzn-signature`. Ваш обработчик должен восстановить ожидаемую подпись в точности так, как это описано в документации BWP для соответствующего типа события и окружения; если значения не совпадают — отклоните вызов. Любой timestamp/nonce, сопровождающий запрос, рассматривайте как часть защиты от повторов (anti-replay): применяйте строгое окно актуальности и сохраняйте обработанные идентификаторы, чтобы избегать дублей.

С операционной точки зрения endpoint должен быть быстрым и детерминированным: сначала верификация, затем подтверждение `2xx` после безопасной фиксации, а самые тяжёлые работы — асинхронно. Если вы полагаетесь на allowlist, помните, что IP-адреса и сети могут меняться — криптографическая проверка является основным источником доверия. Ведите защищённый аудит (request ID, наличие подписи, результат проверки и хэш тела — не секрет). Для локального тестирования допускается заглушить шаг проверки флагом окружения, при этом в продакшене подписи должны проверяться всегда. При ротации ключей или изменении правил каноникализации продвигайтесь вперёд осторожно, следите за уровнем ошибок и документируйте точный набор заголовков и правила хэширования/каноникализации, чтобы остальные сервисы вашего стека оставались синхронизированы.

С точки зрения удобства интеграции, выдавайте **понятные причины отказа** (неверная подпись, устаревший timestamp, некорректный запрос) и возвращайте стабильные коды ошибок, чтобы поведение повторных попыток было предсказуемым. Совместите это с идемпотентностью на уровне приложения и защитой от повторов, чтобы последующие переходы состояния платежей оставались безопасными даже при ретраях, всплесках нагрузки или частичных сбоях.
TEXT
    ,

    // Dari view amazon_bwp.blade.php
    'docs' => 'https://documents.buywithprime.amazon.com/bwp-api/docs/subscribe-to-events',

    'signature_notes' => [
        'Считайте `x-amzn-signature` из заголовков запроса.',
        'Воссоздайте ожидаемую подпись ровно так, как определено Buy with Prime (алгоритм/каноникализация в официальной документации); при несовпадении отклоняйте запрос.',
        'Если передаётся timestamp/nonce, применяйте строгое окно актуальности для защиты от replay-атак; сохраняйте обработанные ID, чтобы избегать дублей.',
    ],

    'example_payload' => [
        'eventType' => 'ORDER_COMPLETED',
        'data' => [
            'orderId' => 'BWP-001',
            'status' => 'COMPLETED',
            'amount' => 25000,
            'currency' => 'IDR',
        ],
        'provider' => 'amazon_bwp',
        'sent_at' => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path' => '/api/payments',
            'desc' => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path' => '/api/payments/{id}',
            'desc' => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path' => '/api/webhooks/amazon_bwp',
            'desc' => __('pages.receive_webhook'),
        ],
    ],
];
