<?php

return [

    'hint' => 'Заголовок подписи с временной меткой.',

    'summary' => <<<'TEXT'
Stripe подписывает каждый webhook-запрос и передаёт вычисленную подпись в заголовке `Stripe-Signature`. Ваш эндпоинт должен проверять запрос до выполнения любых действий. При использовании официальных библиотек Stripe передайте в процедуру проверки три входа: точный raw body запроса, заголовок `Stripe-Signature` и секрет эндпоинта (endpoint secret). Продолжайте обработку только при успешной проверке; иначе верните non-2xx и остановите обработку. Если официальную библиотеку использовать нельзя, реализуйте ручную проверку согласно документации, включая проверку допустимого отклонения по времени (timestamp tolerance), чтобы снизить риск replay.

Считайте проверку подписи строгим «шлюзом». Делайте обработчик идемпотентным (сохраняйте ID событий), быстро возвращайте 2xx после сохранения и выносите тяжёлую работу в фоновые задачи. Убедитесь, что ваш фреймворк даёт доступ к **raw bytes** — не пересериализуйте JSON перед хэшированием, потому что любые изменения пробелов или порядка полей ломают проверку подписи. В конце логируйте минимум диагностики (результат проверки, тип события, хэш body — без секретов) и мониторьте ошибки при ротации секрета или изменениях эндпоинта.
TEXT
    ,

    // dari view Stripe
    'docs' => 'https://docs.stripe.com/webhooks',

    'signature_notes' => [
        'Считайте заголовок `Stripe-Signature`; получите endpoint secret в панели Stripe.',
        'Проверяйте официальными библиотеками, передав: raw body, `Stripe-Signature` и endpoint secret.',
        'При ручной проверке задайте timestamp tolerance для защиты от replay и сравнивайте подписи timing-safe функцией.',
        'Принимайте только при успехе; сохраняйте ID событий для идемпотентности и быстро возвращайте 2xx после сохранения.',
    ],

    'example_payload' => [
        'id' => 'evt_'.now()->timestamp,
        'type' => 'payment_intent.succeeded',
        'data' => [
            'object' => [
                'id' => 'pi_01H',
                'status' => 'succeeded',
            ],
        ],
        'provider' => 'stripe',
        'created_at' => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path' => '/api/payments',
            'desc' => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path' => '/api/payments/{id}',
            'desc' => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path' => '/api/webhooks/stripe',
            'desc' => __('pages.receive_webhook'),
        ],
    ],
];
