<?php

return [

    'hint' => 'HMAC-SHA256 по строке x-timestamp + body.',

    'summary' => <<<'TEXT'
Webhook-и Airwallex подписываются, чтобы вы могли проверить как подлинность, так и целостность запроса до обращения к базе данных. Каждый запрос содержит два критически важных заголовка: `x-timestamp` и `x-signature`. Чтобы проверить сообщение, прочитайте «сырой» HTTP-body ровно в том виде, в котором он был получен, конкатенируйте значение `x-timestamp` (как строку) с этим сырым телом и используйте результат как вход для дайджеста. Затем вычислите HMAC на основе SHA-256, используя общий секрет (shared secret) URL уведомлений в качестве ключа. Airwallex ожидает результат в виде **hex-дайджеста**; сравните его со значением заголовка `x-signature`, используя сравнение с постоянным временем выполнения (constant-time), чтобы избежать утечек по времени. Если подписи не совпадают или метка времени отсутствует/некорректна, необходимо безопасно завершить обработку (fail closed) и вернуть ответ с кодом, отличным от 2xx.

Так как атаки повторного воспроизведения (replay) представляют реальный риск в любой системе Webhook, следует применять окно актуальности (freshness window) к `x-timestamp`. Отклоняйте сообщения, которые слишком стары или слишком сильно сдвинуты в будущее, и сохраняйте идентификаторы уже обработанных событий, чтобы устранять дубликаты последующих побочных эффектов (идемпотентность на уровне приложения). Рассматривайте payload как недоверенные данные до тех пор, пока проверка не будет успешно пройдена; не выполняйте повторную сериализацию JSON перед вычислением хеша — используйте именно те сырые байты, которые были получены, чтобы избежать тонких расхождений из-за пробелов или порядка полей. Когда проверка проходит успешно, как можно быстрее верните ответ `2xx`; тяжёлую работу выполняйте асинхронно, чтобы сохранить корректную логику повторных попыток и снизить вероятность появления дубликатов.

Для локальных и CI-сценариев Airwallex предоставляет первоклассные инструменты: настраивайте URL уведомлений в панели управления, просматривайте примерные payload и **отправляйте тестовые события** на ваш endpoint. При отладке логируйте полученный `x-timestamp`, предварительный вид вычисленной подписи (никогда не логируйте секреты) и, при наличии, идентификатор события. Если вы ротируете секретный ключ, выполняйте это аккуратно и отслеживайте частоту ошибок подписи. Наконец, задокументируйте всю цепочку — проверку, дедупликацию, повторные попытки и обработку ошибок, — чтобы члены команды могли воспроизводить результаты, используя те же правила хеширования «сырого» тела и то же временное окно.
TEXT
    ,

    'docs' => 'https://www.airwallex.com/docs/developer-tools/webhooks/listen-for-webhook-events',

    'signature_notes' => [
        'Извлеките `x-timestamp` и `x-signature` из заголовков.',
        'Соберите value_to_digest = <x-timestamp> + <сырой HTTP-body> (точные байты).',
        'Вычислите expected = HMAC-SHA256(value_to_digest, <webhook secret>) в формате HEX и сравните с `x-signature`, используя сравнение с постоянным временем.',
        'Отклоняйте запрос, если подписи не совпадают или метка времени устарела; также устраняйте дубликаты уже обработанных ID событий, чтобы обеспечить идемпотентность.',
    ],

    'example_payload' => [
        'id'       => 'evt_' . now()->timestamp,
        'type'     => 'payment_intent.succeeded',
        'data'     => [
            'payment_intent_id' => 'pi_awx_001',
            'amount'            => 25000,
            'currency'          => 'IDR',
            'status'            => 'succeeded',
        ],
        'provider'   => 'airwallex',
        'created_at' => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path'   => '/api/payments',
            'desc'   => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path'   => '/api/payments/{id}',
            'desc'   => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path'   => '/api/webhooks/airwallex',
            'desc'   => __('pages.receive_webhook'),
        ],
    ],
];
