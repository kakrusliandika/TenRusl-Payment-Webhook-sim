<?php

return [

    'hint' => 'Заголовок подписи HMAC.',

    'summary' => <<<'TEXT'
Lemon Squeezy подписывает каждый webhook простым HMAC по **сырому телу запроса (raw request body)**. Отправитель использует ваш webhook “signing secret”, чтобы получить HMAC SHA-256 в виде **hex digest**; этот digest отправляется в заголовке `X-Signature`. Ваша задача — прочитать байты тела ровно как они пришли (без повторной сериализации и без изменений пробелов), вычислить такой же HMAC с вашим secret, вывести его как строку в формате **hex** и сравнить с `X-Signature` через constant-time сравнение. Если значения различаются — или заголовок отсутствует — отклоните запрос до выполнения любой бизнес-логики.

Поскольку многие фреймворки по умолчанию парсят body до того, как вы успеете его хэшировать, убедитесь, что ваш маршрут даёт доступ к raw bytes (например, включите обработку “raw body” в Node/Express). Рассматривайте проверку как «ворота»: только после успешной проверки парсьте JSON и обновляйте состояние. Сделайте обработчик идемпотентным, чтобы ретраи/дубликаты не применяли побочные эффекты дважды, и логируйте минимум диагностик (длина заголовка, результат проверки, event id), а не секреты. Для локальных тестов используйте тестовые события Lemon Squeezy и симулируйте ошибки, чтобы проверить retry/backoff. Документируйте весь end-to-end путь — проверка, дедупликация и асинхронная обработка — чтобы команда могла воспроизводить одинаковые результаты в разных окружениях.
TEXT
    ,

    // dari view Lemon Squeezy
    'docs' => 'https://docs.lemonsqueezy.com/help/webhooks/signing-requests',

    'signature_notes' => [
        'Прочитайте `X-Signature` (HMAC-SHA256 в **hex** от raw body) и получите raw bytes запроса.',
        'Вычислите hex HMAC с вашим signing secret и сравните через timing-safe функцию.',
        'Отклоняйте при несовпадении/отсутствии заголовка; JSON парсить только после успешной проверки.',
        'Убедитесь, что фреймворк предоставляет raw body (без ре-сериализации); сделайте обработчик идемпотентным и логируйте минимум диагностики.',
    ],

    'example_payload' => [
        'meta' => ['event_name' => 'order_created'],
        'data' => ['id' => 'ord_001', 'status' => 'paid'],
        'provider' => 'lemonsqueezy',
        'sent_at' => now()->toIso8601String(),
    ],

    'endpoints' => [
        [
            'method' => 'POST',
            'path' => '/api/payments',
            'desc' => __('pages.create_payment'),
        ],
        [
            'method' => 'GET',
            'path' => '/api/payments/{id}',
            'desc' => __('pages.get_payment'),
        ],
        [
            'method' => 'POST',
            'path' => '/api/webhooks/lemonsqueezy',
            'desc' => __('pages.receive_webhook'),
        ],
    ],
];
